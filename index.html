<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>TANGO-CHO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- iOS (Safari) standalone support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="TANGO-CHO" />
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon-v25.png" />
  <link rel="icon" sizes="192x192" href="./icons/icon-192-v25.png" />
  <link rel="icon" sizes="512x512" href="./icons/icon-512-v25.png" />

  <meta name="theme-color" content="#00c896" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="app-header">
    <h1>TANGO-CHO</h1>
    <p class="app-subtitle">èª¿ã¹ã‚‹ï¼‹æ‰‹å…¥åŠ›ã‚’1ç”»é¢ã«çµ±åˆ / å˜èªå¸³ / 4æŠã‚¯ã‚¤ã‚º</p>
  </header>

  <nav class="tab-bar">
    <button class="tab-button active" data-section="addSection">è¿½åŠ </button>
    <button class="tab-button" data-section="listSection">å˜èªå¸³</button>
    <button class="tab-button" data-section="quizSection">ã‚¯ã‚¤ã‚º</button>
  </nav>

  <main class="main">
    <section id="addSection" class="section active">
      <h2>è¿½åŠ ï¼ˆæ¤œç´¢ï¼‹æ‰‹å…¥åŠ›ï¼‰</h2>

      <details class="card" id="settingsCard">
        <summary class="summary">âš™ï¸ æ¥ç¶šè¨­å®šï¼ˆHF Spacesï¼‰ <span id="connStatus" class="conn-status"></span></summary>

        <label class="field-label" for="hfBase">HF Spaces API Baseï¼ˆä¾‹ï¼šhttps://xxxxx.hf.spaceï¼‰</label>
        <div class="field-row">
          <input id="hfBase" type="text" placeholder="https://mazzgogo-tango-cho.hf.space" />
          <button id="saveHfBaseBtn" class="secondary-btn" type="button">ä¿å­˜</button>
        </div>
        <div id="hfBaseStatus" class="status-line"></div>

        <label class="field-label" for="appToken">APP_TOKENï¼ˆSpacesã§è¨­å®šã—ãŸå ´åˆã®ã¿ï¼‰</label>
        <div class="field-row">
          <input id="appToken" type="text" placeholder="æœªè¨­å®šãªã‚‰ç©ºã§OK" />
          <button id="saveAppTokenBtn" class="secondary-btn" type="button">ä¿å­˜</button>
        </div>
        <div id="appTokenStatus" class="status-line"></div>

        <div class="btn-row" style="margin-top:10px">
          <button id="testConnBtn" class="secondary-btn" type="button">æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆ/healthï¼‰</button>
        </div>
        <div id="testConnStatus" class="status-line"></div>
        <div class="btn-row" style="margin-top:10px">
          <button id="storageTestBtn" class="secondary-btn" type="button">ä¿å­˜ãƒ†ã‚¹ãƒˆï¼ˆlocalStorageï¼‰</button>
        </div>
        <div class="btn-row" style="margin-top:10px">
          <button id="resetCacheBtn" class="secondary-btn" type="button">ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ï¼†å†èª­ã¿è¾¼ã¿</button>
        </div>
        <div id="storageTestStatus" class="status-line"></div>
        <div id="currentSettings" class="status-line"></div>
        <div style="height:8px"></div>

        <p class="note">â€» DeepLã‚­ãƒ¼ã¯Spacesã®Secretsï¼ˆDEEPL_KEYï¼‰ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚PWAã«ã¯ä¸è¦ã§ã™ã€‚</p>
      </details>

      <div class="card">
        <div class="field-row">
          <div style="flex:1;">
            <label class="field-label" for="word">è‹±å˜èª</label>
            <input id="word" type="text" placeholder="ä¾‹: curious" autocomplete="off" />
          </div>
          <button id="ttsBtn" class="ghost-btn" title="ç™ºéŸ³">ğŸ”Š</button>
        </div>

        <div class="field-row" style="margin-top:10px;">
          <button id="translateBtn" class="primary-btn">ç¿»è¨³ï¼ˆDeepLï¼‰</button>
          <button id="clearBtn" class="ghost-btn">ã‚¯ãƒªã‚¢</button>
          <div class="pill" id="translateState">æœªç¿»è¨³</div>
        </div>

        <label class="field-label" for="meaning">æ—¥æœ¬èªè¨³ï¼ˆç·¨é›†å¯ï¼‰</label>
        <input id="meaning" type="text" placeholder="ç¿»è¨³ãƒœã‚¿ãƒ³ã§è‡ªå‹•å…¥åŠ› / æ‰‹å…¥åŠ›ã‚‚OK" />

        <div class="two-col">
          <div>
            <label class="field-label" for="status">ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="status" class="select">
              <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
              <option value="forgot">è¦šãˆã¦ãªã„</option>
              <option value="learned">è¦šãˆãŸ</option>
            </select>
          </div>
          <div>
            <label class="field-label" for="tags">ã‚¿ã‚°ï¼ˆä»»æ„ãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
            <input id="tags" type="text" placeholder="ä¾‹: TOEIC, business" />
          </div>
        </div>

        <label class="field-label" for="synonyms">é¡ä¼¼èª / åŒç¾©èªï¼ˆä»»æ„ãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
        <div class="row">
          <input id="synonyms" type="text" placeholder="ä¾‹: inquisitive, interested, wondering" />
          <button id="synFetchBtn" class="secondary-btn" type="button">é¡ç¾©èªå–å¾—</button>
        </div>

        <label class="field-label" for="example">ä¾‹æ–‡ï¼ˆä»»æ„ï¼‰</label>
        <div class="btn-row" style="margin-top:8px">
          <button id="exampleGenBtn" class="secondary-btn" type="button">ä¾‹æ–‡ã‚’è‡ªå‹•ç”Ÿæˆ</button>
        </div>
        <div style="height:10px"></div>
        <textarea id="example" rows="2" placeholder="ä¾‹: I was curious about it."></textarea>

        <label class="field-label" for="memo">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea id="memo" rows="2" placeholder="ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ãƒ»ä½¿ã„åˆ†ã‘ãªã©"></textarea>


      <div id="editBanner" class="edit-banner" style="display:none">
        <div class="edit-title">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</div>
        <div class="edit-sub" id="editSub"></div>
        <button id="cancelEditBtn" class="ghost-btn" type="button">ç·¨é›†ã‚’ã‚„ã‚ã‚‹</button>
      </div>

        <button id="saveBtn" class="secondary-btn full-width">å˜èªå¸³ã«ä¿å­˜</button>

        <div id="msg" class="msg"></div>
      </div>
    </section>

    <section id="listSection" class="section">
      <h2>å˜èªå¸³</h2>
      <div class="card">
        <div class="list-header">
          <span>ç™»éŒ²èªæ•°: <span id="wordCount">0</span></span>
          <div class="list-controls">
            <select id="statusFilter" class="select small">
              <option value="all">å…¨ã¦</option>
              <option value="forgot">è¦šãˆã¦ãªã„</option>
              <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
              <option value="learned">è¦šãˆãŸ</option>
            </select>
            <button id="importBtn" class="ghost-btn">Import</button>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
            <button id="exportBtn" class="ghost-btn">JSON</button>
          </div>
        </div>

        <div id="listMsg" class="msg"></div>

        <div id="wordList" class="word-list"></div>
      </div>
    </section>

    <section id="quizSection" class="section">
      <h2>ã‚¯ã‚¤ã‚ºï¼ˆ4æŠï¼‰</h2>

      <div class="card">
        <div class="two-col">
          <div>
            <label class="field-label" for="quizMode">å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰</label>
            <select id="quizMode" class="select">
              <option value="en2ja">è‹± â†’ æ—¥</option>
              <option value="ja2en">æ—¥ â†’ è‹±</option>
            </select>
          </div>
          <div>
            <label class="field-label" for="quizPool">å‡ºé¡Œã‚«ãƒ†ã‚´ãƒª</label>
            <select id="quizPool" class="select">
              <option value="all">å…¨ã¦</option>
              <option value="forgot">è¦šãˆã¦ãªã„</option>
              <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
              <option value="learned">è¦šãˆãŸ</option>
            </select>
          </div>
        </div>

        <div class="field-row" style="margin-top:10px;">
          <button id="startQuizBtn" class="primary-btn">å‡ºé¡Œ</button>
          <button id="nextQuizBtn" class="ghost-btn" disabled>æ¬¡ã¸</button>
          <div class="pill" id="scorePill">0 / 0</div>
        </div>

        <div id="quizArea" class="quiz-area">
          <p class="note">â€» 4æŠã‚¯ã‚¤ã‚ºã¯ã€å˜èªãŒæœ€ä½4ã¤å¿…è¦ã§ã™ã€‚</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <button id="ttsTestBtn" class="ghost-btn small">ğŸ”Š ãƒ†ã‚¹ãƒˆ</button>
    <span class="footer-text">ç™ºéŸ³: Web Speech API / ç¿»è¨³: HF Spaces â†’ DeepL</span>
    <span class="footer-text" data-version>v3.6.8</span>
  </footer>

  <script src="script.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(console.error);
      });
    }
  </script>
<script>
(function(){
  const HF_BASE_KEY = "tangoChoHfBase";
  const HF_TOKEN_KEY = "tangoChoAppToken";

  function setLine(id, text, type){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = text || "";
    el.classList.remove("ok","err");
    if(type) el.classList.add(type);
  }

  function normalizeBase(raw){
    let v = String(raw || "").trim();
    // Convert huggingface.co/spaces/OWNER/SPACE -> https://owner-space.hf.space
    const m = v.match(/^https?:\/\/huggingface\.co\/spaces\/([^\/]+)\/([^\/?#]+)\/*/i);
    if(m){
      const owner = m[1].toLowerCase();
      const space = m[2].toLowerCase();
      const host = (owner + "-" + space).replace(/[^a-z0-9\-]/g,"-").replace(/\-+/g,"-");
      v = "https://" + host + ".hf.space";
    }
    if(v && !/^https?:\/\//i.test(v)) v = "https://" + v;
    try{
      const u = new URL(v);
      v = u.origin; // strip /health etc
    }catch(e){}
    v = v.replace(/\/+$/,"");
    return v;
  }

  function showDiag(msg, ok){
    const b = document.getElementById("diagBanner");
    if(!b) return;
    b.textContent = msg;
    b.classList.remove("ok","err");
    b.classList.add(ok ? "ok" : "err");
  }

  // Mark JS executed immediately
  showDiag("DIAG: JSå‹•ä½œä¸­ï¼ˆv3.6.8ï¼‰", true);

  // Refs
  const hfBase = document.getElementById("hfBase");
  const appToken = document.getElementById("appToken");
  const saveHf = document.getElementById("saveHfBaseBtn");
  const saveTok = document.getElementById("saveAppTokenBtn");
  const testBtn = document.getElementById("testConnBtn");
  const storageBtn = document.getElementById("storageTestBtn");
  const resetBtn = document.getElementById("resetCacheBtn");

  // Load existing values (do not rely on external script)
  try{
    if(hfBase){
      const v = normalizeBase(localStorage.getItem(HF_BASE_KEY) || hfBase.value || hfBase.getAttribute("placeholder") || "");
      hfBase.value = v;
      setLine("hfBaseStatus", v ? ("ä¿å­˜æ¸ˆã¿: " + v) : "æœªä¿å­˜: HF Base æœªè¨­å®š", v ? "ok" : "err");
    }
    if(appToken){
      const t = (localStorage.getItem(HF_TOKEN_KEY) || "").trim();
      appToken.value = t;
      setLine("appTokenStatus", t ? ("ä¿å­˜æ¸ˆã¿: " + t) : "æœªè¨­å®šï¼ˆç©ºï¼‰", "");
    }
    setLine("currentSettings", "ç¾åœ¨å€¤\nHF_BASE: " + (localStorage.getItem(HF_BASE_KEY)||"(æœªè¨­å®š)") + "\nAPP_TOKEN: " + (localStorage.getItem(HF_TOKEN_KEY)||"(ç©º)"), "");
  }catch(e){
    setLine("testConnStatus", "åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + String(e && e.message ? e.message : e), "err");
  }

  function saveBase(){
    try{
      const v = normalizeBase(hfBase ? hfBase.value : "");
      if(hfBase) hfBase.value = v;
      if(!v){
        setLine("hfBaseStatus","æœªä¿å­˜: HF Base ãŒç©ºã§ã™","err");
        alert("HF Base ãŒç©ºã§ã™");
        return;
      }
      localStorage.setItem(HF_BASE_KEY, v);
      setLine("hfBaseStatus","ä¿å­˜OK: " + v,"ok");
      setLine("currentSettings", "ç¾åœ¨å€¤\nHF_BASE: " + (localStorage.getItem(HF_BASE_KEY)||"(æœªè¨­å®š)") + "\nAPP_TOKEN: " + (localStorage.getItem(HF_TOKEN_KEY)||"(ç©º)"), "");
      alert("ä¿å­˜OK: " + v);
    }catch(e){
      setLine("hfBaseStatus","ä¿å­˜å¤±æ•—: " + String(e && e.message ? e.message : e),"err");
      alert("ä¿å­˜å¤±æ•—: " + String(e && e.message ? e.message : e));
    }
  }

  function saveToken(){
    try{
      const t = (appToken ? appToken.value : "").trim();
      localStorage.setItem(HF_TOKEN_KEY, t);
      setLine("appTokenStatus", t ? ("ä¿å­˜OK: " + t) : "ä¿å­˜OK: æœªè¨­å®šï¼ˆç©ºï¼‰", "ok");
      setLine("currentSettings", "ç¾åœ¨å€¤\nHF_BASE: " + (localStorage.getItem(HF_BASE_KEY)||"(æœªè¨­å®š)") + "\nAPP_TOKEN: " + (localStorage.getItem(HF_TOKEN_KEY)||"(ç©º)"), "");
      alert(t ? ("APP_TOKENä¿å­˜OK: " + t) : "APP_TOKENã¯ç©ºã§ä¿å­˜ã•ã‚Œã¾ã—ãŸ");
    }catch(e){
      setLine("appTokenStatus","ä¿å­˜å¤±æ•—: " + String(e && e.message ? e.message : e),"err");
      alert("ä¿å­˜å¤±æ•—: " + String(e && e.message ? e.message : e));
    }
  }

  async function testHealth(){
    const base = normalizeBase(hfBase ? hfBase.value : "");
    if(hfBase) hfBase.value = base;
    if(!base){
      setLine("testConnStatus","æœªè¨­å®š: HF Base ãŒç©ºã§ã™","err");
      alert("HF Base ãŒç©ºã§ã™");
      return;
    }
    const url = base + "/health";
    setLine("testConnStatus","ãƒ†ã‚¹ãƒˆä¸­: " + url,"");
    if(testBtn){ testBtn.disabled = true; }
    try{
      const controller = new AbortController();
      const timer = setTimeout(()=>controller.abort(), 12000);
      const token = (localStorage.getItem(HF_TOKEN_KEY)||"").trim();
      const res = await fetch(url, {
        method: "GET",
        headers: token ? {"X-App-Token": token} : {},
        signal: controller.signal
      });
      clearTimeout(timer);
      const txt = await res.text();
      if(!res.ok){
        throw new Error("status " + res.status + " - " + txt.slice(0,160));
      }
      setLine("testConnStatus","æ¥ç¶šOK: " + txt,"ok");
      alert("æ¥ç¶šOK: /health");
    }catch(e){
      const msg = (e && e.name === "AbortError") ? "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ(12ç§’)" : String(e && e.message ? e.message : e);
      setLine("testConnStatus","æ¥ç¶šNG: " + msg,"err");
      alert("æ¥ç¶šNG: " + msg);
    }finally{
      if(testBtn){ testBtn.disabled = false; }
    }
  }

  function storageTest(){
    try{
      const k = "tangoChoStorageTest";
      const v = "ok-" + Date.now();
      localStorage.setItem(k, v);
      const r = localStorage.getItem(k);
      setLine("storageTestStatus","storage write/read OK: " + r,"ok");
      alert("ä¿å­˜ãƒ†ã‚¹ãƒˆOK");
    }catch(e){
      setLine("storageTestStatus","storage FAILED: " + String(e && e.message ? e.message : e),"err");
      alert("ä¿å­˜ãƒ†ã‚¹ãƒˆNG: " + String(e && e.message ? e.message : e));
    }
  }

  async function resetCache(){
    try{
      setLine("testConnStatus","ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ä¸­â€¦","");
      if(navigator.serviceWorker){
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r=>r.unregister()));
      }
      if(window.caches){
        const keys = await caches.keys();
        await Promise.all(keys.map(k=>caches.delete(k)));
      }
      alert("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚");
      location.reload();
    }catch(e){
      const msg = String(e && e.message ? e.message : e);
      setLine("testConnStatus","ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤å¤±æ•—: " + msg,"err");
      alert("ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤å¤±æ•—: " + msg);
    }
  }

  // Wire handlers (even if external script fails)
  if(saveHf) saveHf.addEventListener("click", saveBase);
  if(saveTok) saveTok.addEventListener("click", saveToken);
  if(testBtn) testBtn.addEventListener("click", testHealth);
  if(storageBtn) storageBtn.addEventListener("click", storageTest);
  if(resetBtn) resetBtn.addEventListener("click", resetCache);

  // Also expose for console/debug
  window.__tc = {saveBase, saveToken, testHealth, storageTest, resetCache, normalizeBase};
})();
</script>
</body>
</html>
